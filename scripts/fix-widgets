const fs = require("node:fs");
const path = require("node:path");

const EXPORTS_DIR =
  process.argv[2] ??
  path.resolve(process.cwd(), "codex/chatkit-studio/exports");

function looksLikeTsModule(s) {
  return /^\s*export\s+default\s+{/.test(s);
}

function unescapeView(view) {
  // JSON stored view is typically escaped like: \" and \n
  // We want a real template string containing real newlines/quotes.
  return view
    .replace(/\\"/g, '"')
    .replace(/\\n/g, "\n");
}

function toTsWidget(obj) {
  const {
    id,
    name,
    view,
    defaultState,
    schemaMode,
    jsonSchema,
    schema,
    states,
    schemaValidity,
    viewValidity,
    defaultStateValidity,
  } = obj;

  const viewStr = typeof view === "string" ? unescapeView(view) : "";

  return `export default {
  id: ${JSON.stringify(id)},
  name: ${JSON.stringify(name)},

  view: \`${viewStr}\`,

  defaultState: ${JSON.stringify(defaultState ?? {}, null, 2)},

  schemaMode: ${JSON.stringify(schemaMode ?? "zod")},

  jsonSchema: ${JSON.stringify(jsonSchema ?? {}, null, 2)},

  schema: ${JSON.stringify(schema ?? "", null, 2)},

  states: ${JSON.stringify(states ?? [], null, 2)},
  schemaValidity: ${JSON.stringify(schemaValidity ?? "valid")},
  viewValidity: ${JSON.stringify(viewValidity ?? "valid")},
  defaultStateValidity: ${JSON.stringify(defaultStateValidity ?? "valid")},
} as const;
`;
}

function main() {
  if (!fs.existsSync(EXPORTS_DIR)) {
    console.error(`Directory not found: ${EXPORTS_DIR}`);
    process.exit(1);
  }

  const files = fs.readdirSync(EXPORTS_DIR).filter((f) => f.endsWith(".widget"));

  for (const f of files) {
    const full = path.join(EXPORTS_DIR, f);
    const raw = fs.readFileSync(full, "utf8");

    if (looksLikeTsModule(raw)) {
      console.log(`skip (already TS): ${f}`);
      continue;
    }

    let obj;
    try {
      obj = JSON.parse(raw);
    } catch (e) {
      console.log(`skip (not valid JSON): ${f}`);
      continue;
    }

    const out = toTsWidget(obj);
    fs.writeFileSync(full, out, "utf8");
    console.log(`converted: ${f}`);
  }
}

main();